((function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,ba,bb=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1},bc=Array.prototype.slice;c=void 0,f=function(){function a(a){this.str=a}return a}(),D={},C=function(a){return a instanceof f?a:(D[a]||(D[a]=new f(a)),D[a])},z="cons append list quote if set! define lambda begin defmacro".split(" "),W=z.map(C),N=W[0],L=W[1],T=W[2],V=W[3],R=W[4],$=W[5],O=W[6],S=W[7],M=W[8],P=W[9],K=W[10],X={L:T,K:N,P:S,D:O,S:$,M:P,E:C("eq?"),N:C("not"),A:C("and"),O:C("or"),I:R};for(u in X)I=X[u],D[u]=I;Y="quasiquote unquote unquote-splicing".split(" ").map(C),U=Y[0],_=Y[1],ba=Y[2],x={"'":V,"`":U,",":_,",@":ba},r=function(a){},m=new f("#<eof-object>"),b=function(){function a(a){this.file=a,this.line=""}return a.prototype.tokenizer=/\s*(,@|[('`,)]|"(?:[\\].|[^\\"])*"|;|[^\s('"`,;)]*)(.*)/,a.prototype.next_token=function(){var a,b,c,d;for(;;){this.line===""&&(this.line=this.file.readline());if(this.line===""||this.line===void 0)return m;a=this.line,d=this.line.match(this.tokenizer),c=d[0],b=d[1],this.line=d[2];if(a===this.line)return m;if(b[0]==='"')return b;if(""+parseFloat(b)===b)return b;if(b!=="")return b}},a}(),e=function(){function a(a){this.index=0,this.lines=a.trim().split("\n")}return a.prototype.readline=function(){var a;return a=this.lines[this.index++],a.trim().length===0&&this.index<this.lines.length?this.readline():a},a}(),a=function(){function a(a,b,c){a==null&&(a=[]),b==null&&(b=[]),c==null&&(c=!1),this.values={},this.outer=c;if(t(a,"Symbol"))this.values[E(a)]=b;else{if(b.length!==a.length)throw"Expected "+E(a)+", given "+E(b);a.length>0&&(this.values=J(a,b))}}return a.prototype.toString=function(){var a,b;return E(function(){var c,d;c=this.values,d=[];for(a in c)b=c[a],d.push(push([a,""+E(b)]));return d}.call(this))},a.prototype.update=function(a){return this.values=a,this},a.prototype.find=function(a,b){b==null&&(b=!1),t(a,"Symbol")&&(a=E(a));if(this.values[a]!=null)return this;if(!this.outer&&!b){if(typeof window!="undefined"&&window!==null&&window[a])return this.values[a]=window[a],this;throw"Could not find "+a}if(this.outer)try{return this.outer.find(a)}catch(c){if(b)return this;throw c}return this},a.prototype.at=function(a){t(a,"Symbol")&&(a=E(a));if(this.values[a]!=null)return this.values[a];throw"Could not find "+a},a.prototype.setAt=function(a,b,c){return c==null&&(c=!1),t(a,"Symbol")&&(a=E(a)),this.find(a,c).values[a]=b},a}(),d=function(){function b(a,b,c){this.parms=a,this.exp=b,this.env=c}return b.prototype.toString=function(){return E([S,this.parms,this.exp])},b.prototype.applyProc=function(b){return Q(this.exp,new a(this.parms,b,this.env))},b.prototype.apply=function(a,b){return this.applyProc(b)},b.prototype.arity=function(){return this.parms.length},b}(),g=function(a){return a},w=function(a){return F(a)==="string"&&(a=new b(new e(a))),y(a)},y=function(a){var b,c;return b=function(c){var d;if(c!=="("){if(c===")")throw g("unexpected )");if(x[c])return[x[c],y(a)];if(c===m)throw g("unexpected EOF in list");return j(c)}d=[];for(;;){c=a.next_token();if(c===")")return d;d.push(b(c))}},c=a.next_token(),c===m?m:b(c)},B=function(a){return a},A=function(a){return'"'+a+'"'},F=function(){var a,b,c,d,e;a={},e="Boolean Number String Function Array Date RegExp Undefined Null".split(" ");for(c=0,d=e.length;c<d;c++)b=e[c],a["[object "+b+"]"]=b.toLowerCase();return function(b){var c;return c=Object.prototype.toString.call(b),a[c]||"object"}}(),t=function(a,b){return b==="Symbol"&&a instanceof f||b==="Func"&&(a instanceof d||F(a)==="function")||b==="Procedure"&&a instanceof d||b==="Boolean"&&F(a)==="boolean"||b==="String"&&F(a)==="string"||b==="Number"&&F(a)==="number"||b==="List"&&F(a)==="array"||b==="Object"&&F(a)==="object"},j=function(a){return a==="#t"?!0:a==="#f"?!1:a[0]==='"'?B(a.slice(1,-1)):String(Number(a))===a?Number(a):C(a)},E=function(a,b){return b==null&&(b=[]),F(a)==="function"?a:a===!0?"#t":a===!1?"#f":t(a,"Symbol")?a.str:t(a,"String")?A(a):t(a,"List")?"("+a.map(function(a){return bb.call(b,a)>=0?"<CIRCULAR>":E(a,b.concat([a]))}).join(" ")+")":t(a,"Number")?Number(a):t(a,"Procedure")?a.toString():String(a)},G=function(a){return a.length===1&&t(a[0],"List")&&(a=a[0]),a},l=function(a,b,c){c==null&&(c="wrong length");if(!b)throw""+E(a)+": "+c},i=function(a,b){var c,d,e;for(d=0,e=b.length;d<e;d++){c=b[d];if(!a(c))return!1}return!0},s=function(a){return t(a,"List")&&a.length>0},k=function(a,b){return[a].concat(b)},v={},v.let={applyProc:function(a){var b,c,d,e,f,g;f=[],e=[];for(d=0,g=a.length;d<g;d++){b=a[d];if(!s(b)||b[0]!==_key_value_pair)break;f.push(b[1]),e.push(b[2])}return c=a.slice(d),!s(c[0])&&c.length===1?c=c[0]:c=G(c),[[S,f,c]].concat(e)}},v["let*"]={applyProc:function(a){return s(a[0])&&a[0][0]===_key_value_pair?[[S,[a[0][1]],v["let*"].applyProc(a.slice(1))],a[0][2]]:a}},p=0,h=function(a){return a.update({gensym:function(){return C("__SGENSYM__"+p++)},"+":function(a,b){return Number(a)+Number(b)},"-":function(a,b){return a-b},"*":function(a,b){return a*b},"/":function(a,b){return a/b},and:function(){var a,b,c,d,e;b=1<=arguments.length?bc.call(arguments,0):[],c=!0;for(d=0,e=b.length;d<e;d++)a=b[d],a||(c=!1);return c},or:function(){var a,b,c,d,e;b=1<=arguments.length?bc.call(arguments,0):[],c=!1;for(d=0,e=b.length;d<e;d++)a=b[d],a&&(c=!0);return c},"string->symbol":function(a){return C(a)},key:function(a){return a},not:function(a){return!a},">":function(a,b){return a>b},"<":function(a,b){return a<b},">=":function(a,b){return a>=b},"<=":function(a,b){return a<=b},"=":function(a,b){return a===b},sqrt:function(a){return Math.sqrt(a)},abs:function(a){return Math.abs(a)},"eq?":function(a,b){return a===b},length:function(a){return a.length},cons:function(a,b){return k(a,b)},car:function(a){return a[0]},cdr:function(a){if(a.slice!=null&&a.length)return a.slice(1)},member:function(a,b){return bb.call(b,a)>=0},append:function(){var a,b,c,d,e;a=1<=arguments.length?bc.call(arguments,0):[],b=a.shift();for(d=0,e=a.length;d<e;d++)c=a[d],b=b.concat(c);return b},list:function(){var a;return a=1<=arguments.length?bc.call(arguments,0):[],a},"list?":function(a){return t(a,"List")},"atom?":function(a){return!s(a)&&a.length!==0},"null?":function(a){return a.length===0},"symbol?":function(a){return t(a,"Symbol")},"boolean?":function(a){return t(a,"Boolean")},"pair?":function(a){return s(a)},find:function(){var a,b,c,d,e,f;d=arguments[0],a=arguments[1],c=3<=arguments.length?bc.call(arguments,2):[];for(e=0,f=a.length;e<f;e++){b=a[e];if(bb.call(b,d)>=0)return b}return!1},map:function(a,b){var c,d,e,f;f=[];for(d=0,e=b.length;d<e;d++)c=b[d],f.push(a.apply({},[c]));return f},filter:function(a,b){var c,d,e,f;f=[];for(d=0,e=b.length;d<e;d++)c=b[d],a.apply({},[c])&&f.push(c);return f},join:function(a,b){return b.join(a)},str:function(){var a;return a=1<=arguments.length?bc.call(arguments,0):[],a.join("")},apply:function(a,b){return a.apply({},b)},eval:function(a){return Q(n(a))},"eof-object?":function(a){return a===_eof_object},read:function(a){return w(a)},value:function(a){return a},print:function(a){return a!=null?console.log(E(a)):"undefined"},display:function(a,b){return b.pr(t(a,"String")?a:E(a))}})},q=h(new a),Q=function(b,e){var f,g,h,i,j,k,l,m,n,o,p,r,s;e==null&&(e=!1),e||(e=q);for(;;){if(t(b,"Symbol"))return e.find(b).at(b);if(!t(b,"List"))return b;if(b[0]===V)return o=b[0],h=b[1],h;if(b[0]===R)return o=b[0],l=b[1],g=b[2],f=b[3],Q(Q(l,e)?g:f,e);if(b[0]===$)return o=b[0],j=b[1],h=b[2],e.find(j,!0).setAt(j,Q(h,e)),c;if(b[0]===O)return o=b[0],j=b[1],h=b[2],e.setAt(j,Q(h,e),!0),c;if(b[0]===S)return o=b[0],n=b[1],h=b[2],new d(n,h,e);if(b[0]===M){m=!1,s=b.slice(1);for(p=0,r=s.length;p<r;p++)h=s[p],m=Q(h,e);return m}i=function(){var a,c,d;d=[];for(a=0,c=b.length;a<c;a++)h=b[a],d.push(Q(h,e));return d}(),k=i.shift();if(!t(k,"Procedure")){if(k.apply)return k.apply({},i);throw E(k)+" can not be used as function"}b=k.exp,e=new a(k.parms,i,k.env)}},n=function(a,b){var d,e,f,g,h,j,k,m,p,q,r,s,u,w,x,y,z,A,B,D;b==null&&(b=!1),t(a,"List")&&l(a,a.length>0);if(!t(a,"List"))return a;if(a[0]===V)return l(a,a.length===2),a;if(a[0]===R)return a.length===3&&a.push(c),l(a,a.length===4),function(){var b,c,d;d=[];for(b=0,c=a.length;b<c;b++)m=a[b],d.push(n(m));return d}();if(a[0]===$)return l(a,a.length===3),I=a[1],l(a,t(I,"Symbol"),"Can set! only a symbol"),[$,I,n(a[2])];if(a[0]===O||a[0]===P)return l(a,a.length>=3),h=a[0],I=a[1],f=3<=a.length?bc.call(a,2):[],t(I,"List")?(k=I[0],e=2<=I.length?bc.call(I,1):[],n([O,k,[S,e].concat(f[0])])):(l(a,a.length===3),l(a,t(I,"Symbol"),"can define only a symbol"),j=n(a[2]),h===P?(w=Q(j),l(a,t(w,"Procedure"),"macro must be a procedure"),v[E(I)]=w,c):[O,I,j]);if(a[0]===M){if(a.length===1)return c;x=[];for(A=0,B=a.length;A<B;A++)z=a[A],x.push(n(z,b));return x}if(a[0]===S){l(a,a.length>=3),p=a[0],y=a[1],f=3<=a.length?bc.call(a,2):[],l(a,t(y,"List")&&i(function(a){return t(a,"Symbol")},y)||t(y,"Symbol"),"illegal lambda argument list"),g=n(f.length===1?f[0]:[M].concat(f));if(bb.call(y,K)>=0){if(y[y.length-2]!==K)throw"& must be before last arg";s=[];for(u=0,D=y.length;u<D;u++){d=y[u];if(d===K)break;s.push([_key_value_pair,d,[C("_s_args"),u]])}s.push([_key_value_pair,y[u+1],[C("_s_args"),u,-1]]),s.push(g),y=C("_s_args"),g=v.let.applyProc(s)}return[S,y,g]}return a[0]===U?(l(a,a.length===2),n(o(a[1]))):t(a[0],"Symbol")&&v[E(a[0])]?(r=v[E(a[0])].applyProc(a.slice(1)),n(r,b)):function(){var b,c,d;d=[];for(b=0,c=a.length;b<c;b++)q=a[b],d.push(n(q));return d}()},o=function(a){return s(a)?(l(a,a[0]!==ba,"can't splice here"),a[0]===_?(l(a,a.length===2),a[1]):s(a[0])&&a[0][0]===ba?(l(a[0],a[0].length===2),[L,a[0][1],o(a.slice(1))]):a[0]===U?o(o(a.slice(1))[1]):[N,o(a[0]),o(a.slice(1))]):[V,a]},J=function(a,b){var c,d,e,f,g;d={},f=function(a,c){return d[E(a)]=b[c]};for(c=0,g=a.length;c<g;c++)e=a[c],f(e,c);return d},H=function(a){var b,c,d,e,f;b=[],c=[];for(e=0,f=a.length;e<f;e++)d=a[e],b.push(d[0]),c.push(d[1]);return[b,c]},exports.topLevel=q,exports.parse=w,exports.read=y,exports.expand=n,exports.eval=Q,exports.to_string=E,exports.macro_table=v,exports.readEval=function(a){return Q(n(w(a)))};if(typeof window!="undefined"&&window!==null){Z=q.values;for(u in Z)I=Z[u],exports.env[u]=I}})).call(this);